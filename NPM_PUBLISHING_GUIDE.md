# Publishing CodePush CLI to npm

This guide explains how to publish the CodePush CLI as an npm package and how users can consume it.

## ğŸ“¦ Package Structure

The CLI is set up with the following key files:

```
cli/
â”œâ”€â”€ package.json          # Package metadata, scripts, dependencies
â”œâ”€â”€ tsconfig.json         # TypeScript configuration
â”œâ”€â”€ .npmignore           # Files to exclude from npm package
â”œâ”€â”€ script/              # TypeScript source code
â”‚   â”œâ”€â”€ cli.ts          # Entry point (has shebang #!/usr/bin/env node)
â”‚   â”œâ”€â”€ command-parser.ts
â”‚   â”œâ”€â”€ command-executor.ts
â”‚   â””â”€â”€ ...
â””â”€â”€ bin/                 # Compiled JavaScript (generated by tsc)
    â””â”€â”€ script/
        â”œâ”€â”€ cli.js       # Compiled entry point
        â””â”€â”€ ...
```

## ğŸ”‘ Key `package.json` Fields

### `bin` Field
```json
{
  "bin": {
    "code-push-standalone": "./bin/script/cli.js",
    "codepush": "./bin/script/cli.js"
  }
}
```

This creates two executable commands:
- `code-push-standalone` (full name)
- `codepush` (short alias)

### `files` Field
```json
{
  "files": [
    "bin/**/*",
    "README.md",
    "LICENSE.txt"
  ]
}
```

Only includes compiled JavaScript (not TypeScript source) in the published package.

### `scripts` Field
```json
{
  "prepare": "npm run build",        // Runs automatically on install
  "prepack": "npm run build",        // Runs before creating tarball
  "prepublishOnly": "npm run lint && npm test"  // Runs before publishing
}
```

---

## ğŸš€ Publishing Steps

### Step 1: Update Package Name and Version

**For Public Package:**
```json
{
  "name": "code-push-cli",
  "version": "1.0.0"
}
```

**For Scoped/Private Package:**
```json
{
  "name": "@your-org/code-push-cli",
  "version": "1.0.0"
}
```

### Step 2: Build the Package

```bash
cd cli/

# Install dependencies
npm install

# Build TypeScript to JavaScript
npm run build

# This creates bin/ directory with compiled .js files
```

### Step 3: Test Locally

**Option A: Using `npm link` (Recommended)**
```bash
# In cli/ directory
npm link

# Now you can run from anywhere:
code-push-standalone --version
codepush --version
code-push-standalone app ls

# To unlink:
npm unlink -g @your-org/code-push-cli
```

**Option B: Using `npm install -g`**
```bash
# In cli/ directory
npm run local:install

# Or manually:
npm run build
npm install -g
```

**Option C: Test with `npm pack`**
```bash
# Creates a tarball (e.g., code-push-cli-1.0.0.tgz)
npm pack

# Install from tarball in another project
cd /path/to/test-project
npm install /path/to/code-push-server/cli/code-push-cli-1.0.0.tgz

# Test
npx code-push-standalone --version
```

### Step 4: Verify Package Contents

```bash
# Check what files will be published
npm pack --dry-run

# Or create actual tarball and inspect
npm pack
tar -tzf code-push-cli-1.0.0.tgz
```

Should include:
```
package/
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â”œâ”€â”€ LICENSE.txt
â””â”€â”€ bin/
    â””â”€â”€ script/
        â”œâ”€â”€ cli.js
        â”œâ”€â”€ command-parser.js
        â””â”€â”€ ... (all compiled .js files)
```

Should NOT include:
- `script/` (TypeScript source)
- `test/`
- `.eslintrc.json`
- `tsconfig.json`

### Step 5: Login to npm

```bash
# If you haven't logged in before
npm login

# Verify you're logged in
npm whoami
```

### Step 6: Publish

**For Public Package:**
```bash
npm publish
```

**For Scoped Package (Public):**
```bash
npm publish --access public
```

**For Private Package:**
```bash
npm publish --access restricted
```

**For Beta/Test Version:**
```bash
# Publish as beta
npm version 1.0.0-beta.1
npm publish --tag beta

# Users install with:
npm install @your-org/code-push-cli@beta
```

---

## ğŸ“¥ How Users Install and Use

### Installation

**As Global Package (System-wide):**
```bash
npm install -g @your-org/code-push-cli
# or
yarn global add @your-org/code-push-cli
```

**As Dev Dependency (Project-specific):**
```bash
# npm
npm install --save-dev @your-org/code-push-cli

# yarn
yarn add -D @your-org/code-push-cli

# pnpm
pnpm add -D @your-org/code-push-cli
```

### Usage

**1. Direct Command (After Global Install):**
```bash
code-push-standalone app ls
code-push-standalone release-react MyApp ios -d Production

# Or using short alias:
codepush app ls
codepush release-react MyApp ios
```

**2. Using npx (No Install Required):**
```bash
npx @your-org/code-push-cli app ls
npx @your-org/code-push-cli release-react MyApp ios
```

**3. Using npm scripts:**
```json
// In user's package.json
{
  "scripts": {
    "codepush:staging": "code-push-standalone release-react MyApp ios -d Staging",
    "codepush:prod": "code-push-standalone release-react MyApp ios -d Production",
    "codepush:deploy": "code-push-standalone release-react MyApp $PLATFORM -d $DEPLOYMENT"
  }
}
```

Then run:
```bash
npm run codepush:staging
yarn codepush:prod
PLATFORM=android DEPLOYMENT=Production npm run codepush:deploy
```

**4. Using yarn/npm run:**
```bash
# With dev dependency installed
npm exec code-push-standalone app ls
yarn code-push-standalone app ls

# Or via npx
npx code-push-standalone app ls
```

---

## ğŸ”„ Version Management

### Semantic Versioning

```bash
# Patch release (1.0.0 -> 1.0.1) - bug fixes
npm version patch
npm publish

# Minor release (1.0.1 -> 1.1.0) - new features, backward compatible
npm version minor
npm publish

# Major release (1.1.0 -> 2.0.0) - breaking changes
npm version major
npm publish
```

### Pre-release Versions

```bash
# Alpha
npm version 1.1.0-alpha.1
npm publish --tag alpha

# Beta
npm version 1.1.0-beta.1
npm publish --tag beta

# Release Candidate
npm version 1.1.0-rc.1
npm publish --tag rc
```

---

## ğŸ“‹ CI/CD Publishing (GitHub Actions)

Create `.github/workflows/publish.yml`:

```yaml
name: Publish to npm

on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        working-directory: ./cli
        run: npm ci
      
      - name: Build
        working-directory: ./cli
        run: npm run build
      
      - name: Run tests
        working-directory: ./cli
        run: npm test
      
      - name: Publish to npm
        working-directory: ./cli
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

### Setup:
1. Create npm access token: https://www.npmjs.com/settings/[username]/tokens
2. Add to GitHub Secrets as `NPM_TOKEN`
3. Create a GitHub Release to trigger publish

---

## ğŸ” Troubleshooting

### Issue: "ENOENT: no such file or directory" when running CLI

**Cause:** TypeScript not compiled to JavaScript

**Solution:**
```bash
cd cli/
npm run build
```

### Issue: Command not found after global install

**Cause:** npm global bin directory not in PATH

**Solution:**
```bash
# Check npm global bin path
npm bin -g

# Add to PATH (in ~/.bashrc or ~/.zshrc)
export PATH="$PATH:$(npm bin -g)"

# Or use npx instead
npx code-push-standalone app ls
```

### Issue: Permission denied when installing globally

**Cause:** npm prefix owned by root

**Solution:**
```bash
# Option 1: Use nvm (recommended)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install node

# Option 2: Change npm prefix
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
export PATH=~/.npm-global/bin:$PATH
```

### Issue: Published package missing files

**Cause:** Files excluded by `.npmignore` or not in `files` field

**Solution:**
```bash
# Check what will be published
npm pack --dry-run

# Inspect actual tarball
npm pack
tar -tzf your-package-1.0.0.tgz

# Update package.json files field or .npmignore
```

---

## ğŸ“Š Example User Project Setup

```
my-react-native-app/
â”œâ”€â”€ package.json
â”œâ”€â”€ .codepush/
â”‚   â””â”€â”€ config.json          # CodePush configuration
â”œâ”€â”€ android/
â”œâ”€â”€ ios/
â””â”€â”€ scripts/
    â””â”€â”€ deploy-codepush.sh   # Deployment script
```

**package.json:**
```json
{
  "name": "my-react-native-app",
  "version": "1.0.0",
  "scripts": {
    "codepush:login": "code-push-standalone login",
    "codepush:staging:ios": "code-push-standalone release-react MyOrg/MyApp ios -d Staging",
    "codepush:staging:android": "code-push-standalone release-react MyOrg/MyApp android -d Staging",
    "codepush:prod:ios": "code-push-standalone release-react MyOrg/MyApp ios -d Production --mandatory",
    "codepush:prod:android": "code-push-standalone release-react MyOrg/MyApp android -d Production --mandatory",
    "codepush:promote": "code-push-standalone promote MyOrg/MyApp Staging Production"
  },
  "devDependencies": {
    "@your-org/code-push-cli": "^1.0.0",
    "react-native": "^0.72.0"
  }
}
```

**Usage:**
```bash
# First time setup
npm run codepush:login

# Release to staging
npm run codepush:staging:ios
npm run codepush:staging:android

# After testing, promote to production
npm run codepush:promote

# Or release directly to production
npm run codepush:prod:ios
```

---

## âœ… Pre-publish Checklist

Before publishing, ensure:

- [ ] Version number updated in `package.json`
- [ ] `npm run build` completes without errors
- [ ] `npm test` passes (if tests exist)
- [ ] `npm run lint` passes
- [ ] README.md is up to date
- [ ] CHANGELOG.md updated with changes
- [ ] License file exists (LICENSE.txt)
- [ ] `.npmignore` excludes unnecessary files
- [ ] `npm pack --dry-run` shows correct files
- [ ] Tested locally with `npm link`
- [ ] Git repository is clean (no uncommitted changes)
- [ ] Tagged release in git: `git tag v1.0.0 && git push --tags`

---

## ğŸ“š Additional Resources

- [npm documentation - package.json](https://docs.npmjs.com/cli/v9/configuring-npm/package-json)
- [npm documentation - Publishing packages](https://docs.npmjs.com/packages-and-modules/contributing-packages-to-the-registry)
- [Creating Node.js CLI tools](https://nodejs.dev/learn/build-a-nodejs-cli)
- [Semantic Versioning](https://semver.org/)

---

## ğŸ¯ Quick Commands Reference

```bash
# Development
npm install          # Install dependencies
npm run build        # Compile TypeScript
npm run build:watch  # Watch mode
npm test            # Run tests
npm run lint        # Lint code

# Local Testing
npm link            # Link globally for testing
npm run local:install  # Install globally
npm pack            # Create tarball

# Publishing
npm login           # Login to npm
npm whoami          # Check logged in user
npm version patch   # Bump version
npm publish         # Publish package
npm publish --access public  # Publish scoped package

# Managing
npm unpublish @your-org/code-push-cli@1.0.0  # Unpublish specific version
npm deprecate @your-org/code-push-cli@1.0.0 "Use 2.0.0 instead"  # Deprecate
```

---

**You're now ready to publish your CodePush CLI to npm! ğŸš€**


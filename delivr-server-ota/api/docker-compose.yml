# =============================================================================
# Delivr Server OTA - Docker Compose
# =============================================================================
#
# Usage:
#   Development:  docker compose --profile dev up
#   Production:   docker compose --profile prod up -d
#
# Profiles:
#   dev  - Hot reload with nodemon, source code mounted as volume
#   prod - PM2 cluster mode, code baked into image, no volume mounts
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Infrastructure Services (shared between dev and prod)
  # ---------------------------------------------------------------------------
  
  db:
    image: mysql:5.7
    platform: linux/amd64
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASS:-root}
      MYSQL_DATABASE: ${DB_NAME:-delivrdb}
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_PASS:-root}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  memcached:
    image: memcached:alpine
    ports:
      - "11211:11211"
    restart: unless-stopped

  localstack:
    image: localstack/localstack
    environment:
      - SERVICES=s3
    ports:
      - "4566:4566"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  cronicle:
    image: bluet/cronicle-docker:latest
    container_name: cronicle
    hostname: cronicle
    ports:
      - "3012:3012"
    volumes:
      - cronicle_data:/opt/cronicle/data
      - cronicle_logs:/opt/cronicle/logs
    environment:
      - CRONICLE_base_app_url=${CRONICLE_BASE_URL:-http://localhost:3012}
      - CRONICLE_web_socket_use_hostnames=1
      - CRONICLE_server_comm_use_hostnames=1
      - CRONICLE_web_direct_connect=0
      - CRONICLE_master=1
      - CRONICLE_master_lock_mode=1
      - CRONICLE_skip_servers=1
      - TZ=Asia/Kolkata
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3012/api/app/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Application - Development (profile: dev)
  # ---------------------------------------------------------------------------
  
  app-dev:
    profiles: ["dev"]
    build:
      context: ..
      dockerfile: api/Dockerfile
      target: development
    container_name: delivr-app-dev
    ports:
      - "3010:3010"
    volumes:
      # Mount source code for hot reload
      - ../api:/app/api
      - ../pm2:/app/pm2
      # Preserve node_modules (don't overwrite with host)
      - app_node_modules:/app/api/node_modules
    working_dir: /app/api
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
      cronicle:
        condition: service_healthy
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Application - Production (profile: prod)
  # ---------------------------------------------------------------------------
  
  app-prod:
    profiles: ["prod"]
    build:
      context: ..
      dockerfile: api/Dockerfile
      target: production
    container_name: delivr-app-prod
    ports:
      - "3010:3010"
    # No volume mounts - code is baked into image
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      localstack:
        condition: service_healthy
      cronicle:
        condition: service_healthy
    restart: unless-stopped
    # Health check defined in Dockerfile

volumes:
  db_data:
  cronicle_data:
  cronicle_logs:
  app_node_modules:
